<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:AgntsChatUI.ViewModels"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="AgntsChatUI.Views.Components.ChatMessagesComponent"
             x:DataType="vm:ChatViewModel">

	<Design.DataContext>
		<vm:ChatViewModel/>
	</Design.DataContext>

	<!-- Messages -->
	<ScrollViewer Background="White"
                  Name="MessagesScrollViewer"
                  VerticalScrollBarVisibility="Auto"
                  HorizontalScrollBarVisibility="Disabled">
		<StackPanel Spacing="16" Margin="24,24,24,64">
			<ItemsControl ItemsSource="{Binding Messages}">
				<ItemsControl.ItemTemplate>
					<DataTemplate>
						<Grid Margin="0,0,0,16">
							<!-- Message for others (AI) -->
							<StackPanel IsVisible="{Binding !IsSent}" Orientation="Horizontal" Spacing="12" MaxWidth="600" HorizontalAlignment="Left">
								<Border Width="32" Height="32" CornerRadius="16" Background="#4285f4" VerticalAlignment="Top">
									<TextBlock Text="ðŸ¤–" Classes="BodySmall" HorizontalAlignment="Center" VerticalAlignment="Center"/>
								</Border>
								<StackPanel MaxWidth="500">
									<!-- Edit Mode for others -->
									<Border IsVisible="{Binding IsEditing}" Background="#f8f9fa" Padding="12,16" CornerRadius="18" BorderBrush="#e8eaed" BorderThickness="1">
										<StackPanel Spacing="8">
											<TextBox Text="{Binding Content}"
                                                     Foreground="#202124"
                                                     Background="White"
                                                     BorderBrush="#dadce0"
                                                     BorderThickness="1"
                                                     CornerRadius="4"
                                                     Padding="8"
                                                     AcceptsReturn="True"
                                                     TextWrapping="Wrap"/>
											<StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
												<Button Classes="PrimaryButton"
                                                        Content="Save"
                                                        Command="{Binding $parent[UserControl].((vm:ChatViewModel)DataContext).SaveEditCommand}"
                                                        CommandParameter="{Binding}"/>
												<Button Classes="SecondaryButton"
                                                        Content="Cancel"
                                                        Command="{Binding $parent[UserControl].((vm:ChatViewModel)DataContext).CancelEditCommand}"
                                                        CommandParameter="{Binding}"/>
											</StackPanel>
										</StackPanel>
									</Border>

									<!-- Display Mode for others -->
									<Border IsVisible="{Binding !IsEditing}" Background="#f1f3f4" Padding="12,16" CornerRadius="18">
										<Border.ContextFlyout>
											<MenuFlyout>
												<MenuItem Header="Edit" Command="{Binding $parent[UserControl].((vm:ChatViewModel)DataContext).EditMessageCommand}" CommandParameter="{Binding}">
													<MenuItem.Icon>
														<Path Data="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" Fill="#5f6368" Stretch="Uniform" Width="16" Height="16"/>
													</MenuItem.Icon>
												</MenuItem>
												<MenuItem Header="Delete" Command="{Binding $parent[UserControl].((vm:ChatViewModel)DataContext).DeleteMessageCommand}" CommandParameter="{Binding}">
													<MenuItem.Icon>
														<Path Data="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" Fill="#ea4335" Stretch="Uniform" Width="16" Height="16"/>
													</MenuItem.Icon>
												</MenuItem>
											</MenuFlyout>
										</Border.ContextFlyout>
										<TextBlock Text="{Binding Content}" Classes="BodyMedium" Foreground="#202124" TextWrapping="Wrap"/>
									</Border>

									<!-- File attachment for others -->
									<Border IsVisible="{Binding HasFile}" Background="#f8f9fa" BorderBrush="#e8eaed" BorderThickness="1" CornerRadius="8" Padding="12" Margin="0,8,0,0">
										<Grid>
											<Grid.ColumnDefinitions>
												<ColumnDefinition Width="Auto"/>
												<ColumnDefinition Width="*"/>
												<ColumnDefinition Width="Auto"/>
											</Grid.ColumnDefinitions>
											<Border Grid.Column="0" Width="40" Height="40" CornerRadius="8" Background="#4285f4" Margin="0,0,12,0">
												<Path Data="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z" Fill="White" Stretch="Uniform" Width="20" Height="20"/>
											</Border>
											<StackPanel Grid.Column="1">
												<TextBlock Text="{Binding FileName}" FontWeight="Medium" Foreground="#202124" Classes="BodyMedium"/>
												<TextBlock Text="{Binding FileSize}" Classes="Caption" Foreground="#5f6368"/>
											</StackPanel>
											<Button Grid.Column="2"
                                                    Classes="PrimaryButton"
                                                    Content="Download"/>
										</Grid>
									</Border>

									<TextBlock Text="{Binding Time, StringFormat='h:mm tt'}" Classes="Caption" Foreground="#5f6368" Margin="0,4,0,0"/>
								</StackPanel>
							</StackPanel>

							<!-- Message for self -->
							<StackPanel IsVisible="{Binding IsSent}" Orientation="Horizontal" Spacing="12" MaxWidth="600" HorizontalAlignment="Right">
								<StackPanel MaxWidth="500">
									<!-- Edit Mode -->
									<Border IsVisible="{Binding IsEditing}" Background="#e8f0fe" Padding="12,16" CornerRadius="18" BorderBrush="#4285f4" BorderThickness="1">
										<StackPanel Spacing="8">
											<TextBox Text="{Binding Content}"
                                                     Foreground="#202124"
                                                     Background="White"
                                                     BorderBrush="#dadce0"
                                                     BorderThickness="1"
                                                     CornerRadius="4"
                                                     Padding="8"
                                                     AcceptsReturn="True"
                                                     TextWrapping="Wrap"/>
											<StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Right">
												<Button Classes="PrimaryButton"
                                                        Content="Save"
                                                        Command="{Binding $parent[UserControl].((vm:ChatViewModel)DataContext).SaveEditCommand}"
                                                        CommandParameter="{Binding}"/>
												<Button Classes="SecondaryButton"
                                                        Content="Cancel"
                                                        Command="{Binding $parent[UserControl].((vm:ChatViewModel)DataContext).CancelEditCommand}"
                                                        CommandParameter="{Binding}"/>
											</StackPanel>
										</StackPanel>
									</Border>

									<!-- Display Mode -->
									<Border IsVisible="{Binding !IsEditing}" Background="#4285f4" Padding="12,16" CornerRadius="18">
										<Border.ContextFlyout>
											<MenuFlyout>
												<MenuItem Header="Edit" Command="{Binding $parent[UserControl].((vm:ChatViewModel)DataContext).EditMessageCommand}" CommandParameter="{Binding}">
													<MenuItem.Icon>
														<Path Data="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z" Fill="#5f6368" Stretch="Uniform" Width="16" Height="16"/>
													</MenuItem.Icon>
												</MenuItem>
												<MenuItem Header="Delete" Command="{Binding $parent[UserControl].((vm:ChatViewModel)DataContext).DeleteMessageCommand}" CommandParameter="{Binding}">
													<MenuItem.Icon>
														<Path Data="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z" Fill="#ea4335" Stretch="Uniform" Width="16" Height="16"/>
													</MenuItem.Icon>
												</MenuItem>
											</MenuFlyout>
										</Border.ContextFlyout>
										<TextBlock Text="{Binding Content}" Classes="BodyMedium" Foreground="White" TextWrapping="Wrap"/>
									</Border>

									<TextBlock Text="{Binding Time, StringFormat='h:mm tt'}" Classes="Caption" Foreground="#5f6368" Margin="0,4,0,0" HorizontalAlignment="Right"/>
								</StackPanel>
								<Border Width="32" Height="32" CornerRadius="16" Background="#34a853" VerticalAlignment="Top">
									<TextBlock Text="{Binding Avatar}" Classes="Caption" FontWeight="Medium" Foreground="White" HorizontalAlignment="Center" VerticalAlignment="Center"/>
								</Border>
							</StackPanel>
						</Grid>
					</DataTemplate>
				</ItemsControl.ItemTemplate>
			</ItemsControl>

			<!-- Typing Indicator -->
			<StackPanel IsVisible="{Binding IsTyping}" Orientation="Horizontal" Spacing="12" MaxWidth="600" HorizontalAlignment="Left" Margin="0,0,0,16">
				<Border Width="32" Height="32" CornerRadius="16" Background="#4285f4" VerticalAlignment="Top">
					<TextBlock Text="ðŸ¤–" Classes="BodySmall" HorizontalAlignment="Center" VerticalAlignment="Center"/>
				</Border>
				
				<!-- Animated Border Container -->
				<Border CornerRadius="18" Padding="2" BorderThickness="3" Name="AnimatedBorder">
					<Border.BorderBrush>
						<LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
							<LinearGradientBrush.GradientStops>
								<GradientStop Color="#e8eaed" Offset="0"/>
								<GradientStop Color="#e8eaed" Offset="0.45"/>
								<GradientStop Color="#4285f4" Offset="0.48"/>
								<GradientStop Color="#4285f4" Offset="0.52"/>
								<GradientStop Color="#e8eaed" Offset="0.55"/>
								<GradientStop Color="#e8eaed" Offset="1"/>
							</LinearGradientBrush.GradientStops>
						</LinearGradientBrush>
					</Border.BorderBrush>
					<Border CornerRadius="16" Background="#f1f3f4" Padding="12,16">
						<StackPanel Orientation="Horizontal" Spacing="4">
							<Border Width="8" Height="8" CornerRadius="4" Background="#5f6368">
								<Border.Styles>
									<Style Selector="Border">
										<Style.Animations>
											<Animation Duration="0:0:1.5" IterationCount="INFINITE">
												<KeyFrame Cue="0%">
													<Setter Property="Opacity" Value="0.4"/>
												</KeyFrame>
												<KeyFrame Cue="50%">
													<Setter Property="Opacity" Value="1"/>
												</KeyFrame>
												<KeyFrame Cue="100%">
													<Setter Property="Opacity" Value="0.4"/>
												</KeyFrame>
											</Animation>
										</Style.Animations>
									</Style>
								</Border.Styles>
							</Border>
							<Border Width="8" Height="8" CornerRadius="4" Background="#5f6368">
								<Border.Styles>
									<Style Selector="Border">
										<Style.Animations>
											<Animation Duration="0:0:1.5" IterationCount="INFINITE" Delay="0:0:0.2">
												<KeyFrame Cue="0%">
													<Setter Property="Opacity" Value="0.4"/>
												</KeyFrame>
												<KeyFrame Cue="50%">
													<Setter Property="Opacity" Value="1"/>
												</KeyFrame>
												<KeyFrame Cue="100%">
													<Setter Property="Opacity" Value="0.4"/>
												</KeyFrame>
											</Animation>
										</Style.Animations>
									</Style>
								</Border.Styles>
							</Border>
							<Border Width="8" Height="8" CornerRadius="4" Background="#5f6368">
								<Border.Styles>
									<Style Selector="Border">
										<Style.Animations>
											<Animation Duration="0:0:1.5" IterationCount="INFINITE" Delay="0:0:0.4">
												<KeyFrame Cue="0%">
													<Setter Property="Opacity" Value="0.4"/>
												</KeyFrame>
												<KeyFrame Cue="50%">
													<Setter Property="Opacity" Value="1"/>
												</KeyFrame>
												<KeyFrame Cue="100%">
													<Setter Property="Opacity" Value="0.4"/>
												</KeyFrame>
											</Animation>
										</Style.Animations>
									</Style>
								</Border.Styles>
							</Border>
						</StackPanel>
					</Border>
				</Border>
			</StackPanel>
		</StackPanel>
	</ScrollViewer>
</UserControl>